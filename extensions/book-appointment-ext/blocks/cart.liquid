<script language="javascript" type="text/javascript">
  const url = "https://a0dea505e5be.eu.ngrok.io";
  const shop = "testeriphone.myshopify.com";
  const productId = "";

  const items = [];
  {% assign cart_items = cart.items | size %}
  const cartItems = {{cart_items}};
  for(let i=0;i<cartItems;i++) {
    let item = {};
    {% for item in cart.items -%}
      if(i === ({{forloop.index}}-1)) {
        item.productId = {{item.product_id}};
        {% assign property_size = item.properties | size -%}
        {% for p in item.properties -%}
          {% if p.first contains '_' -%}
            item.data = JSON.parse("{{ p.last }}".split("&quot;").join('"'));
          {% endif -%}
        {% endfor -%}
      }
    {% endfor -%}
    items.push(item);
  }

  function cartDelete(index, quantity) {
    const item = items[index]
    console.log(item, quantity)
    if(item && item.data && quantity === 0) {
      fetch(`${url}/api/widget/cart?shop=${shop}&productId=${item.productId}`,
        {
          method: "DELETE",
          headers: {
            Accept: "application/json",
            "Content-Type": "application/json",
          },
          body: JSON.stringify({
            ...item.data,
            staffId: item.data.staff.staff,
          }),
        }
      );
    }
  }

  const { fetch: originalFetch } = window;
  window.fetch = (...args) => {
    let [resource, config] = args;
    if (resource === '/cart/change') {
      const body = JSON.parse(config.body)
      const index = parseInt(body.line) - 1;
      cartDelete(index, parseInt(body.quantity));
    }
    return originalFetch(resource, config);
  };
</script>

{% schema %}
{
  "name": "cart",
  "target": "body",
  "templates": ["cart"],
  "settings": []
}
{% endschema %}
